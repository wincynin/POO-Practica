@startuml
skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

title UPM Store - Class Diagram (Entrega 3)

'--- DOMAIN: PRODUCT ---
package "es.upm.etsisi.poo.domain.product" {
    enum ProductCategory {
        MERCH
        BOOK
        CLOTHES
        STATIONERY
        ELECTRONICS
    }

    enum EventType {
        FOOD
        MEETING
    }

    enum ServiceType {
        TRANSPORT
        EVENT
        INSURANCE
    }

    abstract class Product implements java.io.Serializable {
        - int id
        - String name
        - double price
        - ProductCategory category
        + {abstract} boolean isBookable()
        + {abstract} void validate()
        + {abstract} double getLineTotal(int qty, List<String> custom)
    }

    class StandardProduct {
        + StandardProduct(name, category, price)
    }

    class CustomizableProduct {
        - int maxCustomizableTexts
        - List<String> customTexts
        + double getLineTotal(...)
    }

    abstract class BookableProduct {
        - int maxParticipants
        - LocalDateTime expirationDate
        + {abstract} void validate()
    }

    class EventProduct {
        - EventType type
        + void validate()
    }

    class Service {
        - ServiceType serviceType
        - LocalDateTime expirationDate
        + boolean isBookable()
    }

    class Catalog implements java.io.Serializable {
        - List<Product> products
        + void addProduct(Product p)
        + Product getProduct(int id)
    }

    Product <|-- StandardProduct
    Product <|-- CustomizableProduct
    Product <|-- BookableProduct
    Product <|-- Service
    BookableProduct <|-- EventProduct
    
    StandardProduct ..> ProductCategory
    EventProduct ..> EventType
    Service ..> ServiceType
    Catalog o-- Product
}

'--- DOMAIN: TICKET ---
package "es.upm.etsisi.poo.domain.ticket" {
    enum TicketState {
        EMPTY
        ACTIVE
        CLOSED
    }

    class TicketLine<T extends Product> implements java.io.Serializable {
        - int quantity
        - T product
        - List<String> customTexts
        + double getLineTotal()
    }

    abstract class Ticket<T extends Product> implements java.io.Serializable, Comparable {
        - String id
        - TicketState state
        - List<TicketLine<T>> lines
        - PrintStrategy printStrategy
        + void addProduct(T product, int qty, List<String> texts)
        + String print()
        + void setPrintStrategy(PrintStrategy ps)
    }

    class CommonTicket {
        + CommonTicket(String id)
    }
    note bottom: <T> is StandardProduct

    class CompanyTicket {
        - int productCount
        - int serviceCount
        + CompanyTicket(String id)
        + void addProduct(...)
    }
    note bottom: <T> is Product (Mixed)

    class TicketRepository implements java.io.Serializable {
        - List<Ticket<?>> tickets
        + void add(Ticket<?> ticket)
        + Ticket<?> findById(String id)
    }

    Ticket <|-- CommonTicket
    Ticket <|-- CompanyTicket
    Ticket *-- TicketLine
    TicketLine o-- Product
    TicketRepository o-- Ticket
}

'--- DOMAIN: USER ---
package "es.upm.etsisi.poo.domain.user" {
    abstract class User implements java.io.Serializable {
        - String id
        - String name
        - String email
    }

    class Cashier {
        - List<Ticket<?>> tickets
        + void addTicket(Ticket<?> t)
    }

    abstract class Client {
        + {abstract} boolean validateId(String id)
        + {abstract} void addTicket(Ticket<?> t)
    }

    class IndividualClient {
        - String cashierId
        - List<Ticket<?>> tickets
    }

    class CompanyClient {
        - String cashierId
        - List<Ticket<?>> tickets
    }

    class ClientRepository implements java.io.Serializable {
        - List<Client> clients
    }
    
    class CashierRepository implements java.io.Serializable {
        - List<Cashier> cashiers
    }

    User <|-- Cashier
    User <|-- Client
    Client <|-- IndividualClient
    Client <|-- CompanyClient
    
    ClientRepository o-- Client
    CashierRepository o-- Cashier
}

'--- INFRASTRUCTURE ---
package "es.upm.etsisi.poo.infrastructure" {
    package "printing" {
        interface PrintStrategy implements java.io.Serializable {
            + String formatTicket(Ticket<?> ticket)
        }

        class StandardPrintStrategy
        class CompanyPrintStrategy
        class ServicePrintStrategy

        PrintStrategy <|.. StandardPrintStrategy
        PrintStrategy <|.. CompanyPrintStrategy
        PrintStrategy <|.. ServicePrintStrategy
    }

    package "persistence" {
        class FilePersistenceHandler {
            - String FILE_NAME
            + void save(Store store)
            + Store load()
        }
    }
}

'--- APPLICATION ---
package "es.upm.etsisi.poo.application" {
    class Store implements java.io.Serializable {
        + void addProduct(Product p)
        + Ticket<?> createTicket(...)
        + void addProductToTicket(...)
        + String printTicket(...)
    }
    note top: Facade / Main Model
}

'--- UI ---
package "es.upm.etsisi.poo.ui" {
    interface Command {
        + void execute(String[] args)
    }

    abstract class AbstractCommand {
        # Store store
        + List<String> parseArgs(String args)
    }

    class CommandHandler {
        - Map<String, Command> commands
        + void handle(String input)
    }

    class ProductCommand
    class TicketCommand
    class ClientCommand
    class CashierCommand
    
    class TicketCashierComparator

    Command <|.. AbstractCommand
    AbstractCommand <|-- ProductCommand
    AbstractCommand <|-- TicketCommand
    AbstractCommand <|-- ClientCommand
    AbstractCommand <|-- CashierCommand
    
    CommandHandler o-- Command
}

'--- RELATIONSHIPS ACROSS PACKAGES ---

' Strategy Pattern
Ticket o-right- PrintStrategy

' Store Aggregations (The Hexagon Core)
Store *-- Catalog
Store *-- TicketRepository
Store *-- ClientRepository
Store *-- CashierRepository

' Persistence
FilePersistenceHandler ..> Store : Saves/Loads

' UI to Application
AbstractCommand --> Store : Uses
CommandHandler --> Store : Uses
TicketCashierComparator --> Store : Uses

' User to Ticket Associations
Cashier o-- Ticket : created >
Client o-- Ticket : owns >

@enduml